AJS.PagePermissions=AJS.PagePermissions||{};AJS.toInit(function(d){var g="user",s="group";var j=Confluence.getContextPath();var n=!!d("#rte-button-restrictions").length;var a=null;var k=null;var q=null;var m={addNames:function(v,x){var w=this;var u=v.replace(/\s*,\s*/g,",").split(",");var y=d("#waitImage");y.show();var z={name:u,type:x||"",pageId:AJS.Meta.get("parent-page-id"),spaceKey:AJS.Meta.get("space-key")};d.getJSON(j+"/pages/getentities.action",z,function(E){y.hide();for(var D=0,A=E.length;D<A;D++){var B=E[D].entity;w.addEntity(E[D]);var C=d.inArray(B.name,u);u.splice(C,1)}k.validator.handleNonExistentEntityNames(u)})},addEntity:function(w){if(!w){return}var v=w.entity;var u=w.report;var y=k.getPermissionType();if(k.validator.isDuplicateEntityForType(v,y)){q.highlightEntityRow(v,y);return}var x={entity:v,view:true,edit:true,report:u};q.addRow(x,y);Confluence.Binder.userHover();q.changedByUser();q.highlightEntityRow(v,y);k.nameField.removeFromNameInput(v.name)},makePermissionStrings:function(){var u=q.makePermissionMap(false);return{viewPermissionsUsers:u.user.view.join(","),editPermissionsUsers:u.user.edit.join(","),viewPermissionsGroups:u.group.view.join(","),editPermissionsGroups:u.group.edit.join(",")}},refreshLayout:function(){var z=d("#page-permissions-tables");var y=d("#update-page-restrictions-dialog");var w=y.outerHeight();var u=y.find("h2").outerHeight();var B=y.find(".dialog-button-panel").outerHeight();var x=w-(u+B);var A=d("#page-permissions-editor-form").outerHeight();var v=x-A;d("#update-page-restrictions-dialog .dialog-panel-body").height(x);z.height(v)}};d.extend(AJS.PagePermissions,{addUserPermissions:function(u){m.addNames(u,g)},addGroupPermissions:function(u){m.addNames(u,s)},makePermissionStrings:m.makePermissionStrings});function e(w){q.allowEditing(w.userCanEditRestrictions);q.resetInherited();if(!m.permissionsEdited){q.resetDirect()}if(!w){return}for(var x=0,z=w.permissions.length;x<z;x++){var F=w.permissions[x];var B=F[0].toLowerCase();var u=F[1];var D=F[2];var v=(u==g)?w.users[D]:w.groups[D];var E=F[3];var C=F[4];var y=+E&&E!=AJS.params.pageId;if(m.permissionsEdited&&!y){continue}var A={owningId:E,entity:v.entity,report:v.report};A[B]=true;A.owningTitle=C;A.inherited=y;q.addRow(A,B)}if(w.permissions.length>0){Confluence.Binder.userHover()}q.saveBackup();q.refresh()}function h(){var A=q.makePermissionMap(false),v=d("#rte-button-restrictions .icon"),z=d("#rte-button-restrictions .trigger-text"),x=[].concat(A.group.view).concat(A.user.view).concat(A.group.edit).concat(A.user.edit);if(x.length){v.removeClass("icon-unlocked").addClass("icon-locked");z.text(AJS.I18n.getText("page.restrictions.restricted"))}else{v.removeClass("icon-locked").addClass("icon-unlocked");z.text(AJS.I18n.getText("page.restrictions.none"))}m.permissionsEdited=false;var y=m.makePermissionStrings();for(var u in y){var w=y[u];d("#"+u).val(w);if(m.originalPermissions[u]!=w){m.permissionsEdited=true}}}function p(){k.validator.resetValidationErrors();q.clearHighlight();a.hide();window.scrollTo(m.bookmark.scrollX,m.bookmark.scrollY)}function f(){var v=d(".permissions-update-button").disable();if(n){h();AJS.setVisible("#page-permissions-unsaved-changes-msg",m.permissionsEdited);v.enable();p()}else{var u=m.makePermissionStrings();u.pageId=AJS.params.pageId;d("#waitImage").show();AJS.safe.post(j+"/pages/setpagepermissions.action",u,function(w){d("#waitImage").hide();AJS.setVisible("#content-metadata-page-restrictions",w.hasPermissions);v.enable();p()},"json")}}function c(){p();if(n){q.restoreBackup()}return false}function o(){a=AJS.ConfluenceDialog({width:865,height:530,id:"update-page-restrictions-dialog",onCancel:c});a.addHeader(AJS.I18n.getText("page.perms.dialog.heading"));a.addPanel("Page Permissions Editor",AJS.renderTemplate("page-permissions-div"));a.addButton(AJS.I18n.getText("update.name"),f,"permissions-update-button");a.addCancel(AJS.I18n.getText("close.name"),c);a.popup.element.find(".dialog-title").append(Confluence.Templates.PagePermissions.helpLink());k=AJS.PagePermissions.Controls(m);var u=d("#page-permissions-table").bind("changed",r);q=AJS.PagePermissions.Table(u);m.table=q}function i(u){m.bookmark={scrollX:document.documentElement.scrollLeft,scrollY:document.documentElement.scrollTop};b();k.setVisible(u.userCanEditRestrictions);AJS.setVisible(".permissions-update-button",u.userCanEditRestrictions);a.show();m.refreshLayout()}function t(z,w){var x=(w&&d("#newSpaceKey").val())||AJS.Meta.get("space-key");var u=(w&&d("#parentPageString").val())||"";var y={pageId:AJS.Meta.get("page-id"),parentPageId:AJS.Meta.get("parent-page-id"),parentPageTitle:u,spaceKey:x};var v;if(AJS.params.newPage){y.draftId=AJS.Meta.get("content-id")}d("#waitImage").show();if(n){v=j+"/pages/geteditpagepermissions.action";d.extend(y,{viewPermissionsUsers:d("#viewPermissionsUsers").val(),editPermissionsUsers:d("#editPermissionsUsers").val(),viewPermissionsGroups:d("#viewPermissionsGroups").val(),editPermissionsGroups:d("#editPermissionsGroups").val()})}else{v=j+"/pages/getpagepermissions.action"}d.getJSON(v,y,function(A){d("#waitImage").hide();e(A);z(A)})}function l(u){a||o();t(i,u)}function r(){d(".permissions-update-button").enable();d(".button-panel-cancel-link").text(AJS.I18n.getText("cancel.name"))}function b(){d(".permissions-update-button").disable();d(".button-panel-cancel-link").text(AJS.I18n.getText("close.name"))}d("#content-metadata-page-restrictions, #action-page-permissions-link").click(function(u){l(false);u.preventDefault()});d("#rte-button-restrictions").click(function(u){l(true);u.preventDefault()});if(n){m.originalPermissions={viewPermissionsUsers:d("#viewPermissionsUsers").val(),editPermissionsUsers:d("#editPermissionsUsers").val(),viewPermissionsGroups:d("#viewPermissionsGroups").val(),editPermissionsGroups:d("#editPermissionsGroups").val()}}});