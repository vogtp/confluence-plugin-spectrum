AJS.MacroBrowser=(function(b){var a={};return{hasInit:false,metadataList:[],aliasMap:{},fields:{},Macros:a,getMacroJsOverride:function(c){return a[c]},setMacroJsOverride:function(d,c){return a[d]=c},parseMacro:function(g){var e=g.match(/(\{(.+?)(?::(.*?(?=[^\\]\}).)?)?\})(?:((?:\n|.)*?)\{\2\})?/);var f={markup:e[0],startTag:e[1],name:e[2],paramStr:e[3],bodyMarkup:e[4],params:{}};if(f.markup){var c=g.split(f.markup);f.beforeTag=c[0];f.afterTag=c[1]}if(f.paramStr){var d=f.paramStr.split("|");b(d).each(function(j,k){var h=k.indexOf("=");if(h<0&&!f.params[""]){f.params[""]=k}else{f.params[k.substring(0,h)]=k.substring(h+1)}})}return f},makeParameterDiv:function(k,f,c){var n=this,m;var i=f.type.name;if(c){var h=c.fields&&c.fields[i];if(h&&typeof h!="function"){h=h[f.name]}if(typeof h=="function"){m=h.call(c,f)}}if(!m){if(!(i in n.ParameterFields&&typeof n.ParameterFields[i]=="function")){i="string"}m=n.ParameterFields[i](f)}n.fields[f.name]=m;var j=m.paramDiv;var l=m.input;var d="macro-param-"+f.name;j.attr("id","macro-param-div-"+f.name);l.addClass("macro-param-input").attr("id",d);if(f.hidden){j.hide()}var g=k.pluginKey;if(f.displayName==n.makeDefaultKey(g,k.macroName,"param",f.name,"label")){f.displayName=f.name}if(f.description==n.makeDefaultKey(g,k.macroName,"param",f.name,"desc")){f.description=""}var e=f.displayName;if(f.required){e+=" *";j.addClass("required")}b("label",j).attr("for",d).text(e);if(f.description){j.append(Confluence.Templates.MacroBrowser.macroParameterDesc({description:f.description}))}return j},makeBodyDiv:function(g,c){var e=AJS.MacroBrowser,f=b(Confluence.Templates.MacroBrowser.macroBody()),d;if(c){d=c.body}else{d=e.settings.selectedText}b("textarea",f).val(d||"");if(g.label){b("label",f).text(g.label)}if(g.description){f.append(Confluence.Templates.MacroBrowser.macroParameterDesc({description:g.description}))}if(g.hidden){f.hide()}return f},processRequiredParameters:function(){var c=b("#macro-insert-container .macro-param-div.required .macro-param-input").filter(function(){var g=b(this).val();return(g==null||g=="")});var f=(c.length==0);var e=f?"":"disabled";var d=e?"addClass":"removeClass";AJS.$("#macro-browser-dialog button.ok").attr("disabled",e);AJS.$("#macro-browser-dialog .macro-preview-header .refresh-link").attr("disabled",e)[d]("disabled");return f},paramChanged:function(){AJS.MacroBrowser.processRequiredParameters()},loadMacroInBrowser:function(i,l){if(!i||!i.formDetails){alert(AJS.I18n.getText("macro.browser.unknown.macro.message"));return}var k=AJS.MacroBrowser,r=i.formDetails,e=r.macroName,d=a[e],n=k.settings.selectedMacro,q=l=="edit"?k.editTitle:k.insertTitle,s=tinymce.confluence.macrobrowser.editedMacroDiv;if(e){var d=k.getMacroJsOverride(e);if(d&&typeof d.opener=="function"){k.close();d.opener({name:e});return}}b("#save-warning-span").addClass("hidden");AJS.MacroBrowser.dialog.gotoPage(1).addHeader(q.replace(/\{0\}/,i.title));var u=AJS.$("#macro-browser-dialog .dialog-button-panel .ok");if(l=="edit"){u.text(AJS.I18n.getText("save.name"))}else{u.text(AJS.I18n.getText("insert.name"))}AJS.$("#macro-insert-container .macro-name").val(e);var g=i.extendedDescription?i.extendedDescription:i.description;var v=b(Confluence.Templates.MacroBrowser.macroDescription({description:g})),j=b("#macro-insert-container .macro-input-fields").html(v);if(r.documentationUrl){var m=b(Confluence.Templates.MacroBrowser.macroDocLink({href:r.documentationUrl}));v.append(m)}else{if(!v.text()){v.remove()}}if(r.body&&r.body.bodyType!="NONE"&&(s&&AJS.$(s).hasClass("editor-inline-macro"))){var f=i.pluginKey;if(r.body.label==k.makeDefaultKey(f,e,"body","label")){r.body.label=""}if(r.body.description==k.makeDefaultKey(f,e,"body","desc")){r.body.description=""}var h=k.makeBodyDiv(r.body,k.selectedMacroDefinition);if(h){j.append(h)}}b(r.parameters).each(function(){j.append(k.makeParameterDiv(i,this,d))});var o=n?b.extend({},n.params):{};if(d&&typeof d.beforeParamsSet=="function"){o=d.beforeParamsSet(o,!n)}b(r.parameters).each(function(){var w=this,t;if(w.name==""){t=k.selectedMacroDefinition?k.selectedMacroDefinition.defaultParameterValue:w.defaultValue}else{t=o[w.name]}if(t!=null){delete o[w.name]}else{b(w.aliases).each(function(){if(o[this]){t=o[this];delete o[this]}})}if(t==null){t=w.defaultValue}if(t!=null){k.fields[w.name].setValue(t)}});k.unknownParams=o;b("a",j).click(function(){window.open(this.href,"_blank").focus();return false});if(!b("#macro-browser-dialog:visible").length){k.showBrowserDialog()}var p=b(":input:visible:first",j);if(p.length){p.focus();if(!k.selectedMacroDefinition&&p.val()!=""){p.select()}}var c={};b.extend(true,c,i);if(!c.formDetails){c.formDetails={}}if(!c.formDetails.body){c.formDetails.body={}}k.dialog.activeMetadata=c;if(k.settings.selectedMacro){c.formDetails.body.content=k.settings.selectedMacro.body}else{if(c.formDetails.body.bodyType&&c.formDetails.body.bodyType.toLowerCase()=="plain_text"){c.formDetails.body.content=k.settings.selectedText}else{c.formDetails.body.content=k.settings.selectedHtml}}k.previewMacro(c)},makeParamStringFromMap:function(c){var d=[];if(c[""]){d.push(c[""]);delete c[""]}for(var e in c){d.push(e+"="+c[e])}return d.join("|")},getMacroDefinitionFromForm:function(j){var d=b("#macro-insert-container .macro-name").val(),h,l=AJS.MacroBrowser,i={},e={},k=j.formDetails.parameters;b(k).each(function(){var m=AJS.$("#macro-param-"+this.name);var n=m.val();if(m.attr("type")=="checkbox"){n=""+m.attr("checked")}if(this.shared&&n){e[this.name]=n}else{if(n&&(this.hidden||(!this.defaultValue||this.defaultValue!=n))){if(this.name==""){h=n}else{i[this.name]=n}}}});if(l.unknownParams){b.each(l.unknownParams,function(m,n){i[m]=n})}var c=a[d];if(c&&typeof c.beforeParamsRetrieved=="function"){i=c.beforeParamsRetrieved(i,j,e)}var f=l.getMacroBody();var g={name:d,bodyHtml:f,params:i,defaultParameterValue:h};return g},getMacroParametersFromForm:function(g){var f=g.formDetails.parameters,i=b("#macro-insert-container .macro-name").val(),d=AJS.MacroBrowser,e={},c={};b(f).each(function(){var j=AJS.$("#macro-param-"+this.name);var k=j.val();if(j.attr("type")=="checkbox"){k=""+j.attr("checked")}if(k&&(this.hidden||(!this.defaultValue||this.defaultValue!=k))){e[this.name]=k}if(this.shared&&k){c[this.name]=k}});if(d.unknownParams){b.each(d.unknownParams,function(j,k){e[j]=k})}var h=d.getMacroJsOverride(i);if(h&&typeof h.beforeParamsRetrieved=="function"){e=h.beforeParamsRetrieved(e,g,c)}return e},previewMacro:function(f){var d=AJS.MacroBrowser;b("#macro-insert-container .macro-preview").html("");if(!d.processRequiredParameters()){AJS.log("previewMacro: missing required params");return}AJS.log("previewMacro: required params ok");d.showPreviewWaitImage(true);var h=d.getMacroParametersFromForm(f),e;var g=d.getMacroJsOverride(f.macroName);if(g&&typeof g.updateMacroParametersForPreview=="function"){h=g.updateMacroParametersForPreview(h)}if(h[""]){e=h[""];delete h[""]}var c={name:f.formDetails.macroName,body:d.getMacroBody(),params:h,defaultParameterValue:e};b.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:AJS.params.contextPath+"/rest/tinymce/1/macro/preview",data:AJS.$.toJSON({contentId:Confluence.Editor.getContentId(),macro:c}),dataType:"html",success:function(i){AJS.MacroBrowser.showPreviewWaitImage(false);var n=AJS.params.staticResourceUrlPrefix+"/blank.html";var m=AJS.$("#macro-insert-container .macro-preview");m.html('<iframe src="'+n+'" frameborder="0" name="macro-browser-preview-frame" id="macro-preview-iframe"></iframe>');AJS.log("previewMacro: Created iframe");var j=AJS.$("#macro-insert-container .macro-preview iframe")[0];var l=j.contentDocument||j.contentWindow.document;l.write(i);l.close();var k=b("div.error span.error",l);if(k.length){AJS.log("Error rendering macro definition : ");AJS.log(c)}AJS.log("previewMacro: rendered")}})},showPreviewWaitImage:function(c){if(c){b("#macro-browser-preview-link").attr("disabled",true).addClass("disabled");var d=AJS("div").addClass("macro-loading");b("#macro-browser-preview").append(d);AJS.MacroBrowser.previewSpinner=Raphael.spinner(d[0],60,"#666");AJS.MacroBrowser.previewSpinner.throbber=d}else{if(AJS.MacroBrowser.previewSpinner){b("#macro-browser-preview").removeClass("macro-loading");AJS.MacroBrowser.previewSpinner();AJS.MacroBrowser.previewSpinner.throbber.remove();delete AJS.MacroBrowser.previewSpinner;b("#macro-browser-preview-link").attr("disabled",false).removeClass("disabled")}}},previewOnload:function(c){var e=AJS.MacroBrowser.dialog.activeMetadata.macroName;var d=a[e];if(d&&d.postPreview){d.postPreview(AJS.$("#macro-preview-iframe")[0],AJS.MacroBrowser.dialog.activeMetadata)}AJS.Editor.disableFrame(c);b(c).click(function(h){if(h.target.tagName.toLowerCase()==="a"){var f=h.target;var g=b(f).attr("href");if(g&&g.indexOf("#")!=0&&g.indexOf(window.location)==-1){window.open(g,"_blank").focus()}return false}})},getMacroMetadata:function(f){for(var e=0,c=this.metadataList.length;e<c;e++){var d=this.metadataList[e];if(d.macroName==f){return d}}return null},open:function(e){if(!e){e={};AJS.log("No settings to open the macro browser.")}var d=AJS.MacroBrowser;var f=e.selectedMacro;if(!f&&e.presetMacroMetadata){f={name:e.presetMacroMetadata.macroName}}if(f&&f.name){var c=d.getMacroJsOverride(f.name);if(c&&typeof c.opener=="function"){c.opener(f);return}}if(!d.hasInit){AJS.log("init macro browser");d.showBrowserSpinner(true);if(d.initData){d.initBrowser()}else{d.initMacroBrowserAfterRequest=e;return}}d.openMacroBrowser(e)},openMacroBrowser:function(d){var k=AJS.MacroBrowser;k.settings=d;k.selectedMacroDefinition=d.selectedMacro;var e=(k.selectedMacroDefinition&&k.selectedMacroDefinition.name)||d.presetMacroName;if(d.presetMacroName){d.presetMacroMetadata=k.getMacroMetadata(d.presetMacroName)}var f=d.presetMacroMetadata;if(!f){var l=d.selectedMacro;if(l){var e=l.name.toLowerCase();e=k.aliasMap[e]||e;var c=a[e];if(c){if(typeof c.updateSelectedMacro=="function"){c.updateSelectedMacro(l)}var j=c.getMacroDetailsFromSelectedMacro;if(j){f=j(k.metadataList,l)}}if(!f){f=AJS.MacroBrowser.getMacroMetadata(e)}}}if(f){AJS.log("Open macro browser to edit macro: "+f.macroName);b("#macro-browser-dialog button.back").hide();k.replicateSelectMacro(f,d.mode||"edit")}else{if(e&&!f){b("#macro-browser-dialog button.back").show();k.dialog.overrideLastTab();k.dialog.gotoPage(2);k.showBrowserDialog()}else{b("#macro-browser-dialog button.back").show();if(d.selectedCategory){var g=b("#select-macro-page .dialog-page-menu button").index(b("#category-button-"+d.selectedCategory));if(g<0){g=0}k.dialog.overrideLastTab();k.dialog.gotoPanel(0,g)}else{k.dialog.gotoPage(0)}k.showBrowserDialog();var i=b.trim(d.searchText);var h=b("#macro-browser-search");h.val(i).keyup();i&&h.removeClass("blank-search");h.focus()}}},showBrowserDialog:function(){AJS.MacroBrowser.dialog.show();AJS.MacroBrowser.showBrowserSpinner(false)},complete:function(g){if(!b("#macro-browser-dialog .dialog-button-panel .ok").is(":visible:not(:disabled)")){return}var f=AJS.MacroBrowser;var e=f.dialog.activeMetadata;var d=a[e.macroName];if(d&&d.manipulateMarkup){d.manipulateMarkup(e)}var c=f.getMacroDefinitionFromForm(e);f.close();if(f.settings.onComplete){f.settings.onComplete(c)}},cancel:function(){var c=AJS.MacroBrowser;c.close();if(typeof c.settings.onCancel=="function"){c.settings.onCancel()}return false},close:function(){var c=this;c.unknownParams={};c.fields={};c.dialog.hide()},replicateSelectMacro:function(c,d){AJS.MacroBrowser.loadMacroInBrowser(c,d)},makeDefaultKey:function(){return b.makeArray(arguments).join(".")},showBrowserSpinner:function(c){var d=AJS.Editor.inRichTextMode()?".defaultSkin span.mce_conf_macro_browser":"#editor-insert-macro";if(c){b(d).addClass("wait")}else{b(d).removeClass("wait")}},initBrowser:function(){var r=AJS.MacroBrowser,A=r.initData;if(!A.categories||!AJS.MacroBrowser.metadataList.length){alert(AJS.I18n.getText("macro.browser.load.error.message"));AJS.MacroBrowser.showBrowserSpinner(false);return false}var u=new Date();var y=r.dialog=AJS.ConfluenceDialog({width:865,height:530,id:"macro-browser-dialog",onSubmit:r.complete,onCancel:r.cancel});y.getPage(0).element.attr("id","select-macro-page");y.addHeader(A.title);r.editTitle=A.editTitle;r.insertTitle=A.insertTitle;var s;A.categories=b.map(A.categories,function(i){if(i.name=="hidden-macros"){s=i;return null}return i});A.categories.sort(function(j,i){return(j.displayName.toLowerCase()>i.displayName.toLowerCase()?1:-1)});if(s&&AJS.params.showHiddenUserMacros){A.categories.push(s)}var e=function(i){return b(Confluence.Templates.MacroBrowser.macroSummaryList({category:i}))};var m=function(B){var C=b(Confluence.Templates.MacroBrowser.macroSummaryItem()).click(function(i){AJS.MacroBrowser.loadMacroInBrowser(B,"insert")});if(B.icon){var D=(B.icon.relative?AJS.params.staticResourceUrlPrefix:"")+B.icon.location;if(!B.icon.relative&&AJS.$.browser.msie&&!window.location.href.indexOf("https")&&D.indexOf("https")){C.prepend("<span class='macro-icon-holder icon-"+B.macroName+"'></span>")}else{C.prepend("<img src='"+D+"' alt='icon' width='"+B.icon.width+"' height='"+B.icon.height+"' title='"+B.title+"'/>")}}else{C.prepend("<span class='macro-icon-holder icon-"+B.macroName+"'></span>")}b(".macro-title",C).text(B.title);b(".macro-desc",C).prepend(B.description);if(B.macroName=="gadget"){var j;for(var t=0;t<B.formDetails.parameters.length;t++){if(B.formDetails.parameters[t].name=="url"){j=encodeURI(B.formDetails.parameters[t].defaultValue);break}}if(j){if(!j.match("^https?://.*")){j=AJS.params.contextPath+"/"+j}b(".macro-title",C).after(Confluence.Templates.MacroBrowser.gadgetLink({url:j}))}}return C};var f={all:e("all")},x,n,w,z;for(x=0,n=r.metadataList.length;x<n;x++){var o=r.metadataList[x];if(o.hidden){if(r.isHiddenMacroShown(o)){o.categories.push("hidden-macros")}else{continue}}var q=m(o).attr("id",o.id);f.all.append(q);for(w=0,z=o.categories.length;w<z;w++){var p=o.categories[w];f[p]=f[p]||e(p);f[p].append(m(o).attr("id",p+"-"+o.id))}}y.addPanel(AJS.I18n.getText("macro.browser.category.all"),f.all,"all","category-button-all");for(x=0,n=A.categories.length;x<n;x++){var v=A.categories[x];y.addPanel(v.displayName,f[v.name]||e(v.name),v.name,"category-button-"+v.name).getPanel(x).setPadding(0)}y.addCancel(AJS.I18n.getText("cancel.name"),AJS.MacroBrowser.cancel);y.popup.element.find(".dialog-title").append(Confluence.Templates.MacroBrowser.helpLink());y.addHelpText(AJS.I18n.getText("macro.browser.shortcut.tip"));var h=AJS.$(Confluence.Templates.MacroBrowser.insertMacroPanel());b("#macro-browser-preview-link",h).click(function(i){AJS.MacroBrowser.previewMacro(y.activeMetadata);return AJS.stopEvent(i)});y.addPage().addPanel("X",h,"macro-input-panel").addLink(AJS.I18n.getText("macro.browser.title"),function(i){i.prevPage();b("#macro-browser-search").focus()},"dialog-back-link").addButton("insert.name",function(){AJS.MacroBrowser.complete()},"ok").addCancel(AJS.I18n.getText("cancel.name"),function(){return AJS.MacroBrowser.cancel()}).getPanel(0).setPadding(0);b("#macro-browser-dialog .dialog-button-panel .ok").before("<span id='save-warning-span' class='hidden'/>");var g=function(t){var j=null;if(t!=""){if(y.getCurrentPanel()!=y.getPanel(0)){y.gotoPanel(0)}var i=r.searchSummaries(t);j={};b.each(i,function(){j[this.id]=this})}b("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item").each(function(){(!j||this.id in j)?b(this).show():b(this).hide()})};var k=b("<form id='macro-browser-search-form'><input type='text'/></form>");var c=b("input",k).attr("id","macro-browser-search").keyup(function(i){g(b.trim(c.val()))}).focus(function(j){var i=b(j.target);if(i.hasClass("blank-search")){i.removeClass("blank-search").val("")}j.target.select()}).blur(function(j){var i=b(j.target);if(b.trim(i.val())==""){i.addClass("blank-search").val(AJS.I18n.getText("search.name"))}}).blur();k.submit(function(j){var i=b("#macro-browser-dialog .dialog-panel-body #category-all .macro-list-item:visible");if(b.trim(c.val())!=""&&i.length==1){i.click()}return AJS.stopEvent(j)});y.page[0].header.append(k);y.page[0].ontabchange=function(i,j){if(i!=y.getPanel(0,0)){if(!c.hasClass("blank-search")){c.val("").blur()}g("")}};var d=AJS.$(Confluence.Templates.MacroBrowser.missingUserMacroMetadataPanel({showAdminMessage:AJS.Meta.getBoolean("is-admin")}));y.addPage().addPanel(AJS.I18n.getText("macro.browser.missing.metadata.title"),d,"missing-metadata-panel").addLink(AJS.I18n.getText("macro.browser.back.button"),function(i){i.gotoPage(0);b("#macro-browser-search").focus()},"dialog-back-link").addCancel(AJS.I18n.getText("cancel.name"),function(){return AJS.MacroBrowser.cancel()});y.gotoPage(2);y.addHeader(AJS.I18n.getText("macro.browser.missing.metadata.title"));y.gotoPanel(0,0);y.ready=true;r.hasInit=true;var l=(new Date()).getTime()-u.getTime();AJS.log("loading macro browser took "+l+"ms");return true},loadModel:function(c){if(!c){AJS.log("AJS.MacroBrowser.loadModel - no macro data, aborting");return}AJS.log("AJS.MacroBrowser.loadModel - starting");var m=AJS.MacroBrowser;m.metadataList=[];m.aliasMap={};for(var e=0,l=c.length;e<l;e++){var k=c[e];if(k.aliases){for(var d=0,f=k.aliases.length;d<f;d++){k.aliases[d]=k.aliases[d].toLowerCase();m.aliasMap[k.aliases[d]]=k.macroName.toLowerCase()}}if(k.title==m.makeDefaultKey(k.pluginKey,k.macroName,"label")){k.title=k.macroName.charAt(0).toUpperCase()+k.macroName.substring(1).replace(/-/g," ")}if(k.description==m.makeDefaultKey(k.pluginKey,k.macroName,"desc")){k.description=""}k.id="macro-"+(k.alternateId||k.macroName);var g=[k.macroName,k.title].concat(k.aliases);k.keywordsNoDesc=g.join(",");var h=(k.description&&k.description.replace(/,/g," "))||"";g.push(h);k.keywords=g.join(",");m.metadataList.push(k)}m.metadataList.sort(function(j,i){return(j.title.toLowerCase()>i.title.toLowerCase()?1:-1)});AJS.log("AJS.MacroBrowser.loadModel - complete, "+m.metadataList.length+" macros loaded")},searchSummaries:function(d,c){c=b.extend({splitRegex:/[\s\-]+/},c);return AJS.filterBySearch(this.metadataList,d,c)},getMacroBody:function(){var d=AJS.MacroBrowser;var c="";if(AJS.$("#macro-insert-container .macro-body-div textarea").length){c=AJS.$("#macro-insert-container .macro-body-div textarea").val()}else{if(d.selectedMacroDefinition){if(d.selectedMacroDefinition.body){c=d.selectedMacroDefinition.body}}else{if(d.dialog.activeMetadata){c=d.dialog.activeMetadata.formDetails.body.content}}}return c},isHiddenMacroShown:function(c){return AJS.params.showHiddenUserMacros&&c.pluginKey=="_-user-macro-_"},hasRequiredParameters:function(c){var f=c.formDetails.parameters;for(var d=0,e=f.length;d<e;d++){if(f[d].required){return true}}return false}}})(AJS.$);AJS.toInit(function(b){b(window).bind("render-content-loaded",function(f,c){var d=b("#macro-preview-iframe");if(d.contents().find("body")[0]==c){AJS.MacroBrowser.previewOnload(c)}});var a=AJS.MacroBrowser;AJS.$.ajax({type:"GET",dataType:"json",url:AJS.params.contextPath+"/plugins/macrobrowser/browse-macros.action",success:function(c){a.initData=c;a.loadModel(c.macros);if(a.initMacroBrowserAfterRequest){a.initBrowser();a.openMacroBrowser(a.initMacroBrowserAfterRequest)}},error:function(c){AJS.log("Error requesting macro browser metadata:");AJS.log(c);a.initData={}}})});