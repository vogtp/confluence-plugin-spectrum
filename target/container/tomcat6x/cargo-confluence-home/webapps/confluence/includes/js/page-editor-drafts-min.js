Confluence.Editor.Drafts=(function(c){var e=false,b=false,a=function(h,i,g){c("<input>").attr({type:"hidden",name:h,value:i}).appendTo(g)};var d=function(j){var k=j.getHours();var g=j.getMinutes();var i=k>11?"PM":"AM";k=k%12;return(k==0?"12":k)+":"+(g<10?"0":"")+g+" "+i},f=function(g){Confluence.Editor.Drafts.unBindUnloadMessage();var h=Confluence.Editor.getCurrentForm();a(g,"true",h);a("contentChanged",""+Confluence.Editor.hasContentChanged(),h);a("pageId",AJS.params.pageId,h);if(!h.spaceKey){a("spaceKey",AJS.Meta.get("space-key"),h)}h.action=(AJS.params.newPage?"create":"edit")+AJS.params.draftType+".action";h.submit()};return{isDraftSaved:function(){return e},unloadMessage:function(){if(typeof seleniumAlert!="undefined"||AJS.DarkFeatures.isEnabled("webdriver.test.mode")){b||Confluence.Editor.Drafts.save();b=true;return}if(Confluence.Editor.hasContentChanged()){if(AJS.params.saveDrafts){b||Confluence.Editor.Drafts.save();b=true;return AJS.I18n.getText("saved.draft")}return AJS.I18n.getText("unsaved.comment.lost")}else{if(Confluence.Editor.Drafts.isDraftSaved()){return AJS.I18n.getText("saved.draft")}}},bindUnloadMessage:function(){if(c.browser.msie){window.attachEvent("onbeforeunload",Confluence.Editor.Drafts.unloadMessage)}else{c(window).bind("beforeunload.editor",Confluence.Editor.Drafts.unloadMessage)}},unBindUnloadMessage:function(){if(c.browser.msie){window.detachEvent("onbeforeunload",Confluence.Editor.Drafts.unloadMessage)}else{c(window).unbind("beforeunload.editor")}},useDraft:function(){f("useDraft")},discardDraft:function(){f("discardDraft")},save:function(j){j=j||{};if(!AJS.params.saveDrafts||Confluence.Editor.isSubmitting||(!Confluence.Editor.hasContentChanged()&&!j.forceSave)){AJS.log("skipping draft save");return}AJS.log("preparing to save editor draft");var h=c("#content-title"),g=c("#newSpaceKey"),k=c("#originalVersion"),l=Confluence.Editor.inRichTextMode();var i={pageId:AJS.params.pageId,type:AJS.params.draftType,title:h.hasClass("placeholded")?"":h.val(),spaceKey:g.length?g.val():encodeURIComponent(AJS.Meta.get("space-key")),content:AJS.Rte.getEditor().getContent()};if(k.length){i.pageVersion=parseInt(k.val(),10)}var n=function(p){if(p==null){return}Confluence.Editor.contentHasChangedSinceLastAutoSave=false;if(l){AJS.Rte.Content.editorResetContentChanged()}e=true;c("#draft-error").remove();var o=c("#draft-status"),q=p.time||d(new Date());if(AJS.params.newPage){o.html(AJS.I18n.getText("draft.saved.at.new",q))}else{o.html(AJS.I18n.getText("draft.saved.at",q,"<a id='view-diff-link-heartbeat' class='view-diff-link' href='#'>","</a>"))}if(!+AJS.Meta.get("content-id")){AJS.Meta.set("content-id",p.draftId)}if(c.isFunction(j.onSuccessHandler)){j.onSuccessHandler(p)}Confluence.Editor.Drafts.lastSaveTime=q};var m=function(o,p){Confluence.Editor.addErrorMessage("draft-error",Confluence.Editor.Drafts.lastSaveTime?AJS.I18n.getText("draft.saving.error.previous.draft",Confluence.Editor.Drafts.lastSaveTime):AJS.I18n.getText("draft.saving.error"),true);if(c.isFunction(j.onErrorHandler)){j.onErrorHandler(p)}};c.ajax({type:"POST",url:AJS.params.contextPath+"/rest/tinymce/1/drafts",data:c.toJSON(i),contentType:"application/json",dataType:"text json",success:n,error:m,timeout:30000})}}})(AJS.$);AJS.toInit(function(a){Confluence.Editor.Drafts.bindUnloadMessage();a("#draft-messages a.use-draft").click(function(b){Confluence.Editor.Drafts.useDraft();b.stopPropagation();return false});a("#draft-messages a.discard-draft").click(function(b){Confluence.Editor.Drafts.discardDraft();b.stopPropagation();return false});if(AJS.params.saveDrafts){setInterval(Confluence.Editor.Drafts.save,+AJS.params.draftSaveInterval||30000)}});