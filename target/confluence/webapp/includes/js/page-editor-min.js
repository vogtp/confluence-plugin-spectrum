AJS.log("page-editor starting");Confluence.Editor=(function(a){return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_SOURCE:"source",MODE_PREVIEW:"preview",currentEditMode:null,contentHasChangedSinceLastAutoSave:false,sourceInitialValue:false,isSubmitting:false,hasContentChanged:function(){if(!this.inRichTextMode()&&!this.contentHasChangedSinceLastAutoSave){return false}return this.editorHasContentChanged()},editorHasContentChanged:function(){if(tinyMCE.activeEditor==null){AJS.log("No TinyMCE editor present. Returning empty string in editorHasContentChanged ");return false}return AJS.Rte.Content.editorHasContentChanged()},getResumeDraftUrl:function(){var b=[];b.push(Confluence.getContextPath());b.push("/pages/"+(AJS.params.newPage?"create":"edit")+AJS.params.draftType+".action");b.push("?useDraft=true");b.push("&pageId="+AJS.params.pageId);b.push("&contentChanged="+this.hasContentChanged());this.getCurrentForm().spaceKey&&b.push("&spaceKey="+AJS.Meta.get("space-key"));return b.join("")},getCurrentTitle:function(){return a("#content-title")&&a("#content-title").val()},contentFormSubmit:function(b){Confluence.Editor.Drafts.unBindUnloadMessage();AJS.$(".editable-title #content-title").attr("disabled","disabled");return true},heartbeat:function(){var b={dataType:"json",contentId:AJS.params.pageId,draftType:AJS.params.draftType,spaceKey:AJS.params.spaceKey};if(AJS.params.pageId=="0"||AJS.params.contentType=="comment"){AJS.safe.post(AJS.params.contextPath+"/json/heartbeat.action",{})}else{AJS.safe.post(AJS.params.contextPath+"/json/startheartbeatactivity.action",b,function(c){var g=c.length;if(g){var d=AJS.$("#other-users-span");d.empty();for(var f=0;f<g;++f){if(f>0){d.append(", ")}var e=c[f];d.append(AJS("a").attr("href",AJS.params.contextPath+"/display/~"+encodeURIComponent(e.userName)).text(e.fullName));if(e.lastEditMessage!=null){d.append(" ").append(AJS("span").addClass("smalltext").text(e.lastEditMessage))}}}AJS.setVisible("#heartbeat-div",!!g);a(document).trigger("resize.resizeplugin")},"json")}},disableFrame:function(b){AJS.$("form",b).each(function(){AJS.$(this).unbind();this.onsubmit=function(){return false}});AJS.$("a",b).each(function(){AJS.$(this).attr("target","_top").unbind()});AJS.$("input, img",b).each(function(){AJS.$(this).unbind()})},previewFrameOnload:function(j,g){AJS.log("previewFrameOnload");Confluence.Editor.setMode(Confluence.Editor.MODE_PREVIEW);tinyMCE.activeEditor.setProgressState(false);Confluence.Editor.disableFrame(j);var k=AJS.$("#main",j)[0];if(AJS.Meta.get("content-type")!="comment"&&AJS.$(k).find("#main-header").length==0){AJS.$(k).prepend('<div id="preview-header"><h1 class="pagetitle">'+AJS.$("#title-heading").html()+"</h1></div>")}if(a("#all-messages").children().length<1){a("#editor-precursor").css({display:"none"})}if(AJS.Rte.getEditorContainer().hasClass("resize")){var m=a(g||"#previewArea iframe"),f=0,c=0,d,i=m.height();k&&(function(){var n=a(k).outerHeight(true);if(f!=n){if(n!=m.height()){m.height(0).height(Math.max(n,i))}f=n;c=0}else{c++}if(c<500){d=setTimeout(arguments.callee,500)}})();a(document).one("mode-changed.resize-editor",function(n,o){if(o!=Confluence.Editor.MODE_PREVIEW){d&&clearTimeout(d)}})}else{if(tinymce.isIE||tinymce.isOpera){var b=a(window).height(),h=a("#header-precursor").height()+a("#header").height()+a("#editor-precursor").height(),l=a("#savebar-container").height(),e=4;a("#preview iframe").height(b-h-l-e);a("#content.edit").height("auto")}}},showRichText:function(b){AJS.setVisible("#wysiwyg",b);a("#editor-precursor").css({display:"table-row"});a(".toolbar-group-preview").toggleClass("assistive",!b);a(".toolbar-group-edit").toggleClass("assistive",b);a("#main").toggleClass("active-richtext",b);if(tinymce.isGecko&&b){AJS.Rte.fixEditorFocus(Confluence.Editor.bookmark)}},showPreview:function(b){var c=a("#content-title");if(c.hasClass("placeholded")){a("#preview-title-text").text("");a("#title-text").text("")}else{a("#preview-title-text").text(c.val());a("#title-text").text(c.val())}AJS.setVisible("#preview",b);a(".toolbar-group-preview").toggleClass("assistive",b);a(".toolbar-group-edit").toggleClass("assistive",!b);a("#main").toggleClass("active-preview",b);!!a("#full-height-container").length&&a("#full-height-container").toggleClass("active-preview",b)},showSource:function(b){if(b){this.showSourceArea()}else{this.hideSourceArea()}a("#main")[b?"addClass":"removeClass"]("active-source")},setMode:function(b){AJS.log("Set mode: "+b);if(b==Confluence.Editor.MODE_RICHTEXT){this.showRichText(true);this.showPreview(false);this.showSource(false)}else{if(b==Confluence.Editor.MODE_SOURCE){this.showSource(true);this.showRichText(false);this.showPreview(false)}else{if(b==Confluence.Editor.MODE_PREVIEW){this.showPreview(true);this.showRichText(false);this.showSource(false)}}}this.currentEditMode=b;a(document).trigger("mode-changed",[b])},getContentId:function(){var b=AJS.Meta.get("content-id");if(!+b){b=AJS.Meta.get("page-id")}if(!+b){b="0"}return b},addErrorMessage:function(f,d,e){var c=a("#"+f);var b=(e?"#all-messages":"#editor-messages");if(c.length){c.empty()}else{c=a("<div></div>").attr("id",f).appendTo(b)}AJS.messages.error(c,{closeable:true,body:d})},changeMode:function(f,b){AJS.log("Change mode: "+f);b=b||{};if(this.inRichTextMode()&&!AJS.Rte.BootstrapManager.isInitComplete()){return false}if(this.currentEditMode==f){return false}var c=this.currentEditMode;Confluence.Editor.Drafts.save();if(f==Confluence.Editor.MODE_PREVIEW){var e=AJS.Rte.getEditor();if(c==Confluence.Editor.MODE_SOURCE){Confluence.Editor.transferSourceToEditor()}if(tinyMCE.isGecko&&(c==Confluence.Editor.MODE_RICHTEXT)){Confluence.Editor.bookmark=tinymce.activeEditor.selection.getBookmark()}this.currentEditMode=f;var d={contentId:this.getContentId(),contentType:AJS.params.contentType,spaceKey:AJS.Meta.get("space-key"),xHtml:e.getContent()};a.ajax({type:"POST",url:AJS.params.contextPath+"/pages/rendercontent.action",data:d,success:Confluence.Editor.replysetPreviewArea,timeout:20000,error:function(){Confluence.Editor.addErrorMessage("preview-error",AJS.I18n.getText("editor.preview.error"));Confluence.Editor.currentEditMode=c;b.errorCallback&&b.errorCallback()}})}else{this.setMode(f)}if(f==Confluence.Editor.MODE_RICHTEXT){a(document).trigger("resize.resizeplugin")}return false},replysetPreviewArea:function(b){a("#preview-error").remove();var e=AJS.params.staticResourceUrlPrefix+"/blank.html";tinyMCE.activeEditor.setProgressState(true);AJS.$("#previewArea").html('<iframe src="'+e+'" scrolling="yes" frameborder="0"></iframe>');var c=AJS.$("#previewArea iframe")[0];var d=c.contentDocument||c.contentWindow.document;d.write(b);d.close()},inRichTextMode:function(){return this.currentEditMode==Confluence.Editor.MODE_RICHTEXT},onInit:function(){Confluence.Editor.setMode(Confluence.Editor.MODE_RICHTEXT);tinyMCE.activeEditor.onClick.add(function(b,c){a("#PostingDate").datepicker("hide")})},contentChangeHandler:function(){this.contentHasChangedSinceLastAutoSave=true},getCurrentForm:function(){return AJS.$("form[name="+AJS.params.formName+"]")[0]},transferSourceToEditor:function(){var c=Confluence.Editor;if(c.sourceInitialValue){var b=c.getSourceAreaVal();if(b!=c.sourceInitialValue){var d=tinyMCE.activeEditor;d.setContent(b);d.setDirty(b)}}c.sourceInitialValue=false},hideSourceArea:function(){AJS.$("#editor-html-source-container").addClass("hidden");this.setToolBarInactive(false);this.transferSourceToEditor();a("#rte-button-source-mode").removeClass("active");a("#rte-button-publish").unbind("click.source-save")},showSourceArea:function(){AJS.$("#editor-html-source-container").removeClass("hidden");this.setSourceAreaHeight();this.setToolBarInactive(true);this.sourceInitialValue=tinyMCE.activeEditor.getContent();this.setSourceAreaVal(this.sourceInitialValue);a("#rte-button-source-mode").addClass("active");a("#rte-button-publish").bind("click.source-save",Confluence.Editor.transferSourceToEditor)},getSourceAreaVal:function(){return AJS.$("#editor-html-source").val()},setSourceAreaVal:function(b){AJS.$("#editor-html-source").val(b)},setSourceAreaHeight:function(){var b=AJS.Rte.getTinyMceEditorMinHeight();AJS.log("HTML source height= "+b);var c=a("#editor-html-source")[0].scrollHeight;if(c>b){b=c;AJS.log("ACTUAL HEIGHT "+c)}a("#editor-html-source-container").height(b+"px")},setToolBarInactive:function(b){a("#rte-toolbar").toggleClass("disabled",b)}}})(AJS.$);AJS.toInit(function(d){var e=d("#rte-button-publish"),l=d("#rte-button-overwrite"),b=d("#rte-button-edit"),i=d("#rte-button-preview"),j=i.text(),a=d("#rte-button-cancel"),h=[e,l,b,i,a],k=false,g=Confluence.Editor;var c=function(m){var n,o=h.length;for(n=0;n<o;n++){h[n].toggleClass("disabled",!m)}};var f=function(){return !e.hasClass("disabled")};d(g.getCurrentForm()).submit(function(n){if(!f()){return false}if(!k){var m=AJS.Rte.getEditor().getContent().replace("&nbsp;"," ");if(AJS.Meta.get("content-type")==="comment"&&!d.trim(m)){alert(AJS.I18n.getText("content.empty"));return false}e.text(AJS.I18n.getText("saving.name"));l.text(AJS.I18n.getText("overwriting.name"))}k=false;c(false);return g.contentFormSubmit(n)});this.currentEditMode=this.MODE_RICHTEXT;a.click(function(m){k=true});if(AJS.DarkFeatures.isEnabled("move.page.on.save")){e.click(function(n){n.preventDefault();if(d("#move-page-dialog").length>0){d("#move-page-dialog, body > .shadow, body > .aui-blanket").remove()}var m;if(AJS.Meta.getBoolean("new-page")&&AJS.Meta.get("content-type")!="blogpost"){new Confluence.MovePageDialog({spaceName:m,spaceKey:d("#newSpaceKey").val(),pageTitle:d("#content-title").val(),parentPageTitle:d("#parentPageString").val(),buttonName:AJS.I18n.getText("save.name"),title:AJS.I18n.getText("move.page.dialog.title.edit"),hint:{text:AJS.I18n.getText("move.page.dialog.hint")},moveHandler:function(s,p,t,u,r,q,o){d("#newSpaceKey").val(p);d("#parentPageString").val(u);if(u!=""){d("#position").val("append")}else{d("#position").val("topLevel")}if(r){d("#targetId").val(r);d("#position").val(q)}d(g.getCurrentForm()).submit()}})}else{d(g.getCurrentForm()).submit()}})}b.click(function(m){if(f()){Confluence.Editor.changeMode(g.MODE_RICHTEXT);setTimeout(function(){AJS.Rte.getEditor().focus();if(tinymce.isGecko&&Confluence.Editor.bookmark){AJS.Rte.getEditor().selection.moveToBookmark(Confluence.Editor.bookmark)}},0)}m.preventDefault()});i.click(function(m){if(f()&&g.currentEditMode!=g.MODE_PREVIEW){c(false);i.text(AJS.I18n.getText("show.previewing"));if(tinymce.isGecko&&!Confluence.Editor.bookmark){Confluence.Editor.bookmark=tinymce.activeEditor.selection.getBookmark()}g.changeMode(g.MODE_PREVIEW,{errorCallback:function(){c(true);i.text(j)}})}m.preventDefault()});d("#editor-html-source").change(g.setSourceAreaHeight).keyup(g.setSourceAreaHeight);d("#rte-button-attachments").bind("updateLabel",function(){var n=AJS.Meta.get("num-attachments");var m=(n>1)?AJS.I18n.getText("editor.attachments.plural",n):(n==0)?AJS.I18n.getText("editor.attachments.zero",n):AJS.I18n.getText("editor.attachments.singular",n);d("#rte-button-attachments > .trigger-text").text(m)});d("#rte-button-labels").bind("updateLabel",function(){var n=AJS.Meta.get("num-labels");var m=(n>1)?AJS.I18n.getText("editor.labels.plural",n):(n==0)?AJS.I18n.getText("editor.labels.zero",n):AJS.I18n.getText("editor.labels.singular",n);d("#rte-button-labels  > .trigger-text").text(m)});d("#PostingDate").datepicker({maxDate:new Date()});d("#PostingDate").datepicker("widget").css("display","none");AJS.Rte.BootstrapManager.addOnInitCallback(g.onInit);d(".mceProgress, .mceBlocker",d("#wysiwygTextarea_parent")[0]).live("click",function(){AJS.Rte.getEditor().focus()});d(window).bind("render-content-loaded",function(o,m){var n=d("#previewArea iframe");if(n.contents().find("body")[0]==m){g.previewFrameOnload(m,n);i.text(j);c(true);n.focus();d(document).trigger("iframeAppended",n)}});if(AJS.params.heartbeat){g.heartbeat();setInterval(g.heartbeat,+AJS.Meta.get("heartbeat-interval")||30000)}});AJS.Editor=Confluence.Editor;