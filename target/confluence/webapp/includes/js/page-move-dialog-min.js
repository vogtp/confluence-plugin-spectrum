AJS.toInit(function(e){Confluence.MovePageDialog=function(h){var l=AJS.Meta.get("page-title");h=e.extend({spaceKey:AJS.Meta.get("space-key"),spaceName:AJS.Meta.get("space-name"),pageTitle:l,parentPageTitle:AJS.Meta.get("parent-page-title"),title:AJS.I18n.getText("move.page.dialog.title.view",l),buttonName:AJS.I18n.getText("move.name"),openedPanel:AJS.I18n.getText("move.page.dialog.panel.location"),moveHandler:function(z){AJS.log("No move handler defined. Closing dialog.");z.remove()},cancelHandler:function(z){z.remove();return false}},h);var r={spaceKey:h.spaceKey,spaceName:h.spaceName,parentPageTitle:h.parentPageTitle};var g=h.spaceKey;var t=h.spaceName;var w=h.parentPageTitle;var i="";var m="";var k=function(z,A){i=z;m=A};var x=AJS.ConfluenceDialog({width:800,height:590,id:"move-page-dialog"});x.addHeader(h.title);x.addPanel(AJS.I18n.getText("move.page.dialog.panel.location"),AJS.renderTemplate("movePageDialog"),"location-panel","location-panel-id");x.addPanel(AJS.I18n.getText("move.page.dialog.search.title"),AJS.renderTemplate("movePageSearchPanel"),"search-panel","search-panel-id");x.addPanel(AJS.I18n.getText("move.page.dialog.history.title"),Confluence.Templates.MovePage.historyPanel({pageTitle:AJS.Meta.get("page-title")}),"history-panel","history-panel-id");x.addPanel(AJS.I18n.getText("move.page.dialog.browse.title"),Confluence.Templates.MovePage.browsePanel({pageTitle:AJS.Meta.get("page-title")}),"browse-panel","browse-panel-id");x.get('#"'+AJS.I18n.getText("move.page.dialog.panel.location")+'"')[0].onselect=function(){e("#new-space-key").val(g);e("#new-space").val(t);e("#new-parent-page").val(w).select()};x.get('#"'+AJS.I18n.getText("move.page.dialog.search.title")+'"')[0].onselect=function(){e("#move-page-dialog .search-panel .search-results .selected").removeClass("selected");e("#move-page-dialog input.search-query").focus()};x.get('#"'+AJS.I18n.getText("move.page.dialog.history.title")+'"')[0].onselect=function(){e(".history-panel",u).movePageHistory(o)};x.get('#"'+AJS.I18n.getText("move.page.dialog.browse.title")+'"')[0].onselect=function(){AJS.log("browse: "+[g,t,w].join());e(".browse-panel",u).movePageBrowse(o,g,t,w,n,h.pageTitle)};var s=function(A){A.nextPage();var z=e("#move-page-dialog");e(".ordering-panel",z).movePageOrdering(g,w,h.pageTitle,k)};var q=function(A){var C=e("#new-space:visible").val();var B=e("#new-space-key").val();var z=e("#new-parent-page:visible").val();if(C&&(C!=t||B!=g||z!=w)){AJS.MoveDialog.getBreadcrumbs({spaceKey:B,pageTitle:z},function(){Confluence.PageLocation.set({spaceKey:B,spaceName:C,parentPageTitle:z});h.moveHandler(A,B,C,z,i,m,f)},function(D){e("#new-parent-breadcrumbs").html(Confluence.Templates.MovePage.breadcrumbError());if(D.status==404){o.error(AJS.I18n.getText("move.page.dialog.location.not.found"))}})}else{Confluence.PageLocation.set({spaceKey:g,spaceName:t,parentPageTitle:w});h.moveHandler(A,g,t,w,i,m,f)}};var y=function(z){if(e("#reorderCheck")[0].checked){s(z)}else{q(z)}};x.addButton(h.buttonName,y,"move-button");x.addCancel(AJS.I18n.getText("cancel.name"),h.cancelHandler);x.popup.element.find(".dialog-title").append(Confluence.Templates.MovePage.helpLink());x.addPage().addHeader(h.title).addPanel(AJS.I18n.getText("move.page.dialog.ordering.title"),Confluence.Templates.MovePage.orderingPagePanel(),"ordering-panel","ordering-panel-id").addLink(AJS.I18n.getText("move.page.dialog.back.button"),function(z){z.prevPage()},"dialog-back-link").addButton(AJS.I18n.getText("move.page.dialog.order.button"),q,"reorder-button").addCancel(AJS.I18n.getText("cancel.name"),h.cancelHandler);var v=x.get("button#"+h.buttonName)[0].item;e("button.move-button").before(Confluence.Templates.MovePage.reorderCheckbox());x.gotoPage(0);x.show();var u=e("#move-page-dialog");e(".location-panel .location-info",u).appendTo(e(".dialog-page-body:first",u));e(".dialog-button-panel:visible",u).prepend(Confluence.Templates.MovePage.errorMessage());var j=new AJS.MoveDialog.Breadcrumbs(e("#new-parent-breadcrumbs"));function f(z){if(!z||z.length==0){e("#move-errors").addClass("hidden");e(v).attr("disabled","");return}if(!e.isArray(z)){z=[z]}e("#move-errors").text(z[0]).attr("title",z.join("\n")).removeClass("hidden");x.gotoPage(0)}var o={moveButton:v,clearErrors:function(){f([])},error:f,select:function(B,A,z){AJS.log("select: "+[B,A,z].join());g=B;t=A;w=z||"";e(v).attr("disabled","disabled");j.update({spaceKey:g,title:w},o)}};x.overrideLastTab();x.get('#"'+h.openedPanel+'"').select();var n=AJS.Meta.get("parent-page-title")||AJS.Meta.get("from-page-title");var p=new AJS.MoveDialog.Breadcrumbs(e("#current-parent-breadcrumbs"));p.update({spaceKey:AJS.Meta.get("space-key"),title:n},o);e(".location-panel",u).movePageLocation(o);e(".search-panel",u).movePageSearch(o);e(".history-panel",u).movePageHistory(o);e("#new-parent-page").select();if(h.hint){x.addHelpText(h.hint.template||h.hint.text,h.hint.arguments)}return u};var d=function(h,g,i,f){var j={pageId:AJS.params.pageId,spaceKey:h};if(i){j.position=f;j.targetId=i}else{if(g!=""){j.targetTitle=g;j.position="append"}else{j.position="topLevel"}}return j};function a(j,l,f,m,o,g,i){j=j.popup.element;j.addClass("waiting");e("button",j).attr("disabled","disabled");var h=e("<div class='throbber'></div>");j.append(h);var n=Raphael.spinner(h[0],100,"#666");function k(p){i(p);j.removeClass("waiting");n();e("button",j).attr("disabled","")}e.ajax({url:contextPath+"/pages/movepage.action",type:"GET",dataType:"json",data:new d(l,m,o,g),error:function(){k(AJS.I18n.getText("move.page.dialog.move.failed"))},success:function(p){var q=[].concat(p.validationErrors||[]).concat(p.actionErrors||[]).concat(p.errorMessage||[]);if(q.length>0){k(q);return}window.location.href=contextPath+p.page.url+(p.page.url.indexOf("?")>=0?"&":"?")+"moved=true"}})}e("#action-move-page-dialog-link").click(function(f){f.preventDefault();if(e("#move-page-dialog").length>0){e("#move-page-dialog, body > .shadow, body > .aui-blanket").remove()}new Confluence.MovePageDialog({moveHandler:a});return false});var c;e("#rte-button-location").click(function(f){f.preventDefault();if(e("#move-page-dialog").length>0){e("#move-page-dialog, body > .shadow, body > .aui-blanket").remove()}new Confluence.MovePageDialog({spaceName:c,spaceKey:e("#newSpaceKey").val(),pageTitle:e("#content-title").val(),parentPageTitle:e("#parentPageString").val(),buttonName:AJS.I18n.getText("move.name"),title:AJS.I18n.getText("move.page.dialog.title.edit"),moveHandler:function(k,h,l,m,j,i,g){c=l;e("#newSpaceKey").val(h);e("#parentPageString").val(m);if(m!=""){e("#position").val("append")}else{e("#position").val("topLevel")}if(j){e("#targetId").val(j);e("#position").val(i)}k.remove()}});return false});var b=null;Confluence.PageLocation={get:function(){if(b){return b}return{spaceName:AJS.Meta.get("space-name"),spaceKey:AJS.Meta.get("space-key"),parentPageTitle:AJS.Meta.get("parent-page-title")}},set:function(f){b=f}}});