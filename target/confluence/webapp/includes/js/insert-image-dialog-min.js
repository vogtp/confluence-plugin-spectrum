jQuery.fn.sizeToFit=function(){var a=jQuery;this.each(function(){var d=this;var b=a(this).parent();var e=b.height();b.children().each(function(){if(this!=d){e-=a(this).outerHeight()}});var c=a(this).outerHeight()-a(this).height();a(this).css("height",Math.max(0,e-c)+"px")});return this};Confluence.Editor.ImageDialog={beforeShowListeners:[],afterThumbnailsDisplayedListeners:[],panelComponent:[]};AJS.toInit(function(c){Confluence.Editor.ImageDialog.findPanelComponentById=function(h){var e=Confluence.Editor.ImageDialog.panelComponent;for(var f=0,g=e.length;f<g;f++){if(e[f].id==h){return e[f]}}return undefined};AJS.wikiAttrToString=function(e){var f=[];for(var g in e){if(e.hasOwnProperty(g)){f.push(typeof e[g]=="boolean"?e[g]?g:"":g+"="+e[g])}}return f.length?"|"+f.join(","):""};Confluence.Editor.defaultInsertImageDialog=function(){var f=function(g){AJS.Rte.BookmarkManager.restoreBookmark();tinymce.confluence.ImageUtils.insertFromProperties(g);if(!!c("#comments-section").length){AJS.Rte.fixEditorFocus()}},e=function(){AJS.Rte.BookmarkManager.restoreBookmark()};AJS.Rte.BookmarkManager.storeBookmark();Confluence.Editor.insertImageDialog(f,e)};Confluence.Editor.insertImageDialog=function(f,e){this.openImageDialog({submitCallback:f,cancelCallback:e})};var a=function(e,f,g){c(document).bind("keydown.insert-image",function(i){if(!e.is(":visible")){return}if(c("#fancybox-overlay").is(":visible")){if(i.which==32){c("#fancybox-close").click();i.preventDefault();i.stopPropagation();return false}}else{function h(n){var k=c(".attached-image",e);var m=c(".attached-image.selected",e);var j=k.index(m)+n;if(j<0){j=k.length-1}if(j>=k.length){j=0}var l=k.eq(j);l.click().focus();e.simpleScrollTo(l)}if(i.which==37){h(-1);return AJS.stopEvent(i)}else{if(i.which==38){h(-4);return AJS.stopEvent(i)}else{if(i.which==39){h(1);return AJS.stopEvent(i)}else{if(i.which==40){h(4);return AJS.stopEvent(i)}else{if(i.which==32&&c(".attached-image.selected").length>0){c(g.imageSelector+".selected .zoom").click();return AJS.stopEvent(i)}else{if(i.which==13&&f.isInsertAllowed()){f.insert();return AJS.stopEvent(i)}}}}}}}})};var d=function(e,g,j,m){var h=100,m=m||new Confluence.Highlighter(),k=g.name||g.fileName,o;if(Math.max(g.thumbnailWidth,g.thumbnailHeight)>h){if(g.thumbnailHeight>g.thumbnailWidth){g.thumbnailWidth=g.thumbnailWidth*h/g.thumbnailHeight;g.thumbnailHeight=h}else{g.thumbnailHeight=g.thumbnailHeight*h/g.thumbnailWidth;g.thumbnailWidth=h}}if(!g.thumbnailUrl&&g.thumbnailLink){g.thumbnailUrl=g.thumbnailLink.href}if(!g.downloadUrl&&g.link){for(var f=0,n=g.link.length;f<n;f++){var l=g.link[f];if(l.rel=="download"){g.downloadUrl=l.href;break}}}o=c(Confluence.Templates.Image.imageDialogListItem({image:g,nonceUrl:g.thumbnailUrl&&g.thumbnailUrl+(g.thumbnailUrl.indexOf("?")+1?"&":"?")+"nonce="+(+new Date),imageTooltip:k+(g.space&&(" ("+g.space.name+")")||""),topMargin:g.thumbnailHeight&&(100-g.thumbnailHeight)/2,parentTitleClass:j?"":"hidden",imageName:k,parentTitle:g.parentTitle||"",highlightedImageName:m.highlight(k),highlightedParentTitle:m.highlight(g.parentTitle||"")}));o.attr("data-owner-id",g.ownerId||"");o.attr("data-destination",AJS.REST.wikiLink(g).destination);o.find(".image-container").andSelf().hover(function(){c(this).addClass("hover")},function(){c(this).removeClass("hover")});o.find("img").load(function(){o.find(".image-container").removeClass("loading")});o.click(function(i){c("#insert-image-dialog .image-list .selected").removeClass("selected");c(this).addClass("selected").focus();e.selectedName=this.name=this.name||c(".caption.filename",this).text();e.selectedOwnerId=c(this).attr("data-owner-id");e.selectedDestination=c(this).attr("data-destination");e.allowInsert(true);i.stopPropagation();return false});o.dblclick(function(){c(this).click();e.insert()});c(".zoom",o).fancybox({padding:0,zoomSpeedIn:500,zoomSpeedOut:500,overlayShow:true,overlayOpacity:0.5});return o};var b=function(f,e){var h=e.imageContainer.find(".image-list"),i=c.map(e.justAttached||[],function(r){return r&&r.toLowerCase()}),q=f.options,m=e.imageContainer,n=e.images||[],j=e.noImageMessage,k=e.showParentTitle,o=e.highlighter,p=e.displayErrors,l=[],g;m.find(".loading-message").addClass("hidden");m.find(".no-images").remove();c(n).each(function(){if(this.name&&c.inArray(this.name.toLowerCase(),i)!=-1){h.prepend(d(f,this,k,o))}else{h.append(d(f,this,k,o))}});if(h.find("li").length==0){m.append(c("<p></p>").addClass("no-images").text(j))}m.sizeToFit().click(function(){f.clearSelection()});if(i.length){h.find("li:first").click()}else{if(q.imageProperties&&q.imageProperties.imageFileName){imageContainter.find("img[src*=/"+q.imageProperties.imageFileName+"?]").click()}}l=[];g=c.map(n,function(r){return r.name&&r.name.toLowerCase()});c.each(i,function(r,s){if(c.inArray(s,g)==-1){l.push(AJS.I18n.getText("unsupported.file.error",s))}});if(l.length){p(l)}};Confluence.Editor.openImageDialog=function(o){o=o||{};var m=new AJS.Dialog(800,590,"insert-image-dialog"),f={baseElement:m.popup.element,selectedName:"",selectedOwnerId:null,selectedDestination:null,allowInsert:null,isInsertAllowed:null,insert:null,attachmentSourceContentId:AJS.Meta.get("attachment-source-content-id"),options:o,clearSelection:null,imageContainerSupport:{bindImageContainer:a,refreshImageList:b},addPanel:function(s,i,q,p){var r=m.getPage(0).panel.length;m.addPanel(s,i,q,p);return r},selectPanel:function(i){m.selectPanel(i)},getPanel:function(i){return m.getPanel(i)}},e=AJS.I18n.getText("image.browser.insert.title"),n=AJS.I18n.getText("image.browser.insert.button"),l,g;f.clearSelection=function(){f.selectedName="";f.selectedOwnerId=null;f.selectedDestination=null;f.allowInsert(false);f.baseElement.find(".image-list .selected").removeClass("selected")};function j(){m.hide().remove();c(document).unbind(".insert-image");o.cancelCallback&&o.cancelCallback();return false}c(document).bind("keydown.insert-image",function(i){if(i.which==27&&!c("#fancybox-overlay").is(":visible")){j();return AJS.stopEvent(i)}});if(o.imageProperties){e=AJS.I18n.getText("image.browser.edit.title");n=AJS.I18n.getText("image.browser.edit.button")}m.addHeader(e);m.addButton(n,function(p){var r=p.getCurrentPanel().body;var i=c("input.image-url",r).val();var q={url:i,filename:f.selectedName,contentId:f.selectedOwnerId||f.attachmentSourceContentId};p.remove();c(document).unbind(".insert-image");if(o.submitCallback){o.submitCallback(q)}},"insert");l=m.popup.element;l.attr("data-tab-default","0");g=l.find(".dialog-button-panel .insert");f.allowInsert=function(i){g.attr("disabled",(i?"":"disabled"))};f.allowInsert(false);f.isInsertAllowed=function(){return !g.is(":disabled")};f.insert=function(){g.click()};c.each(Confluence.Editor.ImageDialog.panelComponent,function(){this&&this.createPanel&&this.createPanel(f)});m.addCancel(AJS.I18n.getText("cancel.name"),j);for(var k,h=0;k=m.getPanel(h);h++){k.setPadding(0)}AJS.log(Confluence.Editor.ImageDialog.beforeShowListeners.length+" beforeShow listeners registered.");c.each(Confluence.Editor.ImageDialog.beforeShowListeners,function(){this()});m.show();m.popup.element.find(".dialog-button-panel").append(c("<div></div>").addClass("dialog-tip").html(AJS.I18n.getText("insert.image.did.you.know")))}});