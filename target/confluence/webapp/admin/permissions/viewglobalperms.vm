#* @vtlvariable name="action" type="com.atlassian.confluence.security.actions.AbstractPermissionsAction" *#
#* @vtlvariable name="groupRow" type="com.atlassian.confluence.security.administrators.DefaultPermissionsAdministrator.GroupPermissionRow" *#
#* @vtlvariable name="userRow" type="com.atlassian.confluence.security.administrators.DefaultPermissionsAdministrator.UserPermissionRow" *#

<html>
    <head>
        <title>$action.getActionName($action.getClass().getName())</title>
    </head>

    <body>
        #requireResource("confluence.web.resources:global-permissions-inline-dialog")
        <content tag="selectedWebItem">perms</content>
        #parse ( "/template/includes/actionerrors.vm" )

        <p class="stepdesc">
            $i18n.getText('global.permissions.description')
            #doc("help.global.permissions.overview" "permissions guide").
        </p>
            <form name="editglobalperms" class="aui" action="editglobalpermissions.action">
                <div style="float:right">
                    #tag( "Submit" "name='edit-permissions'" "value='globalperms.editpermissions'" "theme='notable'")
                </div>
                <h2>$i18n.getText('perms.groups')</h2>
                <div class="stepdesc">
                    $i18n.getText("global.group.perms")
                </div>

                <table id="gPermissionsTable" width="100%" border="0" cellpadding=4 cellspacing=0>
                #set ($groupRows = $action.groupPermissionRows)
                #if (!$groupRows.empty)
                    #showGlobalPermissionsHeader()
                    #foreach ($groupRow in $groupRows)
                        <tr data-key="$generalUtil.htmlEncode($groupRow.groupName)" style=" #if ($velocityCount % 2 == 0) background: #f0f0f0; #end">
                            <td>
                                $generalUtil.htmlEncode($groupRow.groupName)
                                #if (!$groupRow.entityExists())
                                    <br/><span class="errorMessage">$action.getText("error.group.not.found")</span>
                                #elseif ($groupRow.caseInvalid)
                                    <br/><span class="errorMessage">$action.getText('error.permission.incorrect.case', [$generalUtil.htmlEncode($groupRow.group.name)])</span>
                                #end
                            </td>

                            #foreach ($permission in $action.permissions)
                                <td align="center" class="permissionCell"
                                    data-permission="$generalUtil.htmlEncode($permission)"
                                    data-permission-group="$generalUtil.htmlEncode($groupRow.groupName)"
                                    data-permission-set="$groupRow.isTypeAllowed($permission)">
                                    #if ($groupRow.isTypeAllowed($permission))
                                        <img src="$staticResourceUrlPrefix/images/icons/emoticons/check.png" width=16 height=16 align=absmiddle border=0>
                                        #if ($permission == 'useconfluence') $action.getText('perms.can.use') #end
                                    #else
                                        <img src="$staticResourceUrlPrefix/images/icons/emoticons/error.png" width=16 height=16 align=absmiddle border=0>
                                        #if ($permission == 'useconfluence') $action.getText('perms.cant.use') #end
                                    #end
                                </td>
                            #end
                        </tr>
                    #end
                #else
                    <tr><td colspan=5>$action.getText('globalperms.no.group.access')</td></tr>
                #end
                </table>

                <br/>

                <h2>$i18n.getText('perms.individuals')</h2>
                <div class="stepdesc">
                    $action.getText("global.user.perms")
                </div>

                <table id="uPermissionsTable" width="100%" border="0" cellpadding=4 cellspacing=0>
                #set ($userRows = $action.userPermissionRows)
                #if (!$userRows.empty)
                    #showGlobalPermissionsHeader()
                    #foreach ($userRow in $userRows)
                        <tr data-key="$generalUtil.htmlEncode($userRow.username)" style=" #if ($velocityCount % 2 == 0) background: #f0f0f0; #end">
                            <td>
                                #if ($userRow.entityExists())
                                    $generalUtil.htmlEncode($userRow.user.fullName)
                                #end
                                <span class="grey">($generalUtil.htmlEncode($userRow.username))</span>
                                #if (!$userRow.entityExists())
                                    <br/><span class="errorMessage">$action.getText("error.user.not.found")</span>
                                #elseif ($userRow.caseInvalid)
                                    <br/><span class="errorMessage">$action.getText('error.permission.incorrect.case', [$generalUtil.htmlEncode($userRow.user.name)])</span>
                                #end
                            </td>
        #foreach ($permission in $action.permissions)
                                <td align="center" class="permissionCell"
                                    data-permission="$generalUtil.htmlEncode($permission)"
                                    data-permission-user="$generalUtil.htmlEncode($userRow.username)"
                                    data-permission-set="$userRow.isTypeAllowed($permission)">
                                    #if ($userRow.isTypeAllowed($permission))
                                        <img src="$staticResourceUrlPrefix/images/icons/emoticons/check.png" width=16 height=16 align=absmiddle border=0>
                                        #if ($permission == 'useconfluence') $action.getText('perms.can.use') #end
                                    #else
                                        <img src="$staticResourceUrlPrefix/images/icons/emoticons/error.png" width=16 height=16 align=absmiddle border=0>
                                        #if ($permission == 'useconfluence') $action.getText('perms.cant.use') #end
                                    #end
                                </td>
                            #end
                        </tr>
                    #end
                #else
                    <tr><td colspan=5>$action.getText('globalperms.no.user.perms')</td></tr>
                #end
                </table>
                <br/>

                <h2>$i18n.getText('perms.anonymous')</h2>
                <div class="stepdesc">
                    $action.getText("global.anonymous.perms")
                </div>

                <table id="aPermissionsTable" width="790" border="0" cellpadding=4 cellspacing=0>
                <tr>
                    <th width="230" class="permissionHeading">&nbsp;</th>
                    <th width="280" class="permissionTab">
                        $i18n.getText("permissions.USECONFLUENCE")
                        <a href="#" class="inlineDialog-useConfluence inline-help">$i18n.getText("inline.dialog.help")</a>
                    </th>
                    <th width="280" class="permissionTab">
                        $action.getText("permissions.VIEWUSERPROFILES")
                        <a href="#" class="inlineDialog-viewProfiles inline-help">$i18n.getText("inline.dialog.help")</a>
                    </th>
                </tr>
                <tr>
                    <td>
                        $action.getText('perms.anonymous.user')
                    </td>
                    #set ($anonymousRow = $action.anonymousPermissionRow)
                    <td align="center" class="permissionCell">
                        #if ($anonymousRow.isTypeAllowed('useconfluence'))
                            <img src="$staticResourceUrlPrefix/images/icons/emoticons/check.png" width=16 height=16 align=absmiddle border=0> $action.getText('perms.can.use')
                        #else
                            <img src="$staticResourceUrlPrefix/images/icons/emoticons/error.png" width=16 height=16 align=absmiddle border=0> $action.getText('perms.cant.use')
                        #end
                    </td>
                    <td align="center" class="permissionCell">
                        #if ($anonymousRow.isTypeAllowed('VIEWUSERPROFILES'))
                            <img src="$staticResourceUrlPrefix/images/icons/emoticons/check.png" width=16 height=16 align=absmiddle border=0>
                        #else
                            <img src="$staticResourceUrlPrefix/images/icons/emoticons/error.png" width=16 height=16 align=absmiddle border=0>
                        #end
                    </td>
                </tr>
                </table>
                <p>#tag( "Submit" "name='edit-permissions'" "value='globalperms.editpermissions'" "theme='notable'")</p>
            </form>
        #parse ( "/breadcrumbs.vm" )
    </body>
</html>
